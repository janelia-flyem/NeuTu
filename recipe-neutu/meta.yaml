package:
  {% if NEUTU_TARGET is defined %}
    name: {{NEUTU_TARGET}}
  {% else %}
    name: neutu
  {% endif %}

  {% if GIT_DESCRIBE_NUMBER|int == 0 %}
    version: "{{GIT_DESCRIBE_TAG}}"
  {% else %}
    # If we're using a non-tagged revision, append '.postN' to the version
    version: "{{GIT_DESCRIBE_TAG}}.post{{GIT_DESCRIBE_NUMBER}}"
  {% endif %}

source:
    git_url: ../
    patches:
      - patches/libgl-is-in-build-prefix.patch  # [linux]

build:
  number: 0
  string: {{PKG_BUILDNUM}}_g{{GIT_FULL_HASH[:7]}}

  script_env:
   - NEUTU_TARGET
   - THREAD_COUNT

requirements:
  build:
    - make
    - cmake
    - {{ compiler('cxx') }}          # [linux]

    # CDT packages for linking against libGL
    # These are packages which we expect NeuTu users to have installed on their own machines.
    # https://conda-forge.org/docs/maintainer/knowledge_base.html#core-dependency-tree-packages-cdts
    # https://github.com/conda-forge/cdt-builds
    - {{ cdt('mesa-libgl-devel') }}  # [linux]
    - {{ cdt('mesa-libegl-devel') }} # [linux]
    - {{ cdt('mesa-dri-drivers') }}  # [linux]
    - {{ cdt('libselinux') }}        # [linux]
    - {{ cdt('libxdamage') }}        # [linux]
    - {{ cdt('libxxf86vm') }}        # [linux]
    - {{ cdt('libxext') }}           # [linux]
    - {{ cdt('libxcb') }}            # [linux]
    - {{ cdt('libxfixes') }}         # [linux]
    - {{ cdt('expat') }}             # [linux]

    # Should we upgrade to CentOS-7 sysroot?
    # https://conda-forge.org/docs/user/announcements.html?highlight=sysroot_linux#centos-7-docker-images-are-now-the-default
    # https://conda-forge.org/docs/maintainer/knowledge_base.html#using-centos-7
    #- sysroot_linux-64 2.17          # [linux]

  host:
    # FlyEM packages
    - libneucore >=0.1.5,<2.0
    - libneumath >=0.1.0,<2.0
    - lowtis  0.1.0.post78.*

    # Packages from our channel (flyem-forge)
    - draco     1.3.4
    - glbinding 2.1.3
    
    # from conda-forge, pinned here
    - jansson   2.7
    - xorg-libxrandr  1.5.2       # [linux]
    - xorg-libxcursor 1.2.0       # [linux]
    - xorg-libxtst    1.2.3       # [linux]

    # 'pin_run_as_build' in conda_build_config.yaml
    - fftw        {{ fftw }}
    - libiconv    {{ libiconv }}
    - libpng      {{ libpng }}
    - pango       {{ pango }}     # [linux]
    - qt          {{ qt }}
    - vtk         {{ vtk }}  # Note: Must be the same as VTK_VER in neurolabi/gui/extlib.pri

    # No 'pin_run_as_build' provided
    - alsa-lib    {{ alsa_lib }}  # [linux]
    - assimp      {{ assimp }}
    - hdf5        {{ hdf5 }}
    - libarchive  {{ libarchive }}
    - librdkafka  {{ librdkafka }}
    - tbb         {{ tbb }}
    - tbb-devel   {{ tbb_devel}}

  run:
    # FlyEM packages
    - libneucore >=0.1.5,<2.0
    - libneumath >=0.1.0,<2.0
    - lowtis  0.1.0.post78.*

    # Packages from our channel (flyem-forge)
    - draco     ==1.3.4
    - glbinding ==2.1.3

    # from conda-forge, but pinned here.
    - jansson   2.7.*
    - xorg-libxrandr ==1.5.2    # [linux]
    - xorg-libxcursor ==1.2.0   # [linux]
    - xorg-libxtst ==1.2.3      # [linux]

    # 'pin_run_as_build' in conda_build_config.yaml
    - fftw
    - libiconv
    - libpng
    - pango  # [linux]
    - qt
    - vtk

    # No 'pin_run_as_build' provided
    - {{ pin_compatible("alsa-lib") }} # [linux]
    - {{ pin_compatible("assimp") }}
    - {{ pin_compatible("hdf5") }}
    - {{ pin_compatible("libarchive") }}
    - {{ pin_compatible("librdkafka") }}
    - {{ pin_compatible("tbb") }}
    - {{ pin_compatible("tbb-devel") }}

    # runtime only (not listed above in build)
    - python  3.7.*
    - marktips 0.3.*

about:
  home: http://github.com/janelia-flyem/NeuTu
  license: GPL
